
# Preprocessing pipeline
## Installation
The preprocessing pipeline is optimized for Ubuntu and MacOS.

1. Clone project and intialize submodules

   ```bash
   git clone https://github.com/teresa-canasbajo/bdd-driveratt
   git submodule update --init
   ```

2. Run Make file: generates a virtual environment (bdddriverattenv), runs requirements.pip with all required python packages and requirements for Pupil Labs.

   ```python
   make
   ```

3. You may need to install the following packages with sudo/root privileges:

   `cysignals`
   
   `pyglui` <-- for Mac users, make sure you have XCODE installed and set up.
   
   `glfw3` <-- for Mac users, they might need to install this through brew: `brew install glfw3`. Ubuntu OK. 

### Installing Cysignals in Ubuntu
The code to install cysignals has been removed from the Makefile to make it accessible by Ubuntu/Mac/Windows. 
To install in Ubuntu: 
1. Add cysignals in line 30.

2. Add the following code to makefile:
```
cysignalssrc = ${installfolder}/build/src_cysignals

${cysignalssrc}:
		git clone https://github.com/sagemath/cysignals ${cysignalssrc}

cysignals: ${VENV} ${cysignalssrc}
		echo 'trying to install cysignals..' 
		cd ${cysignalssrc} && \
		sudo apt-get install python3-sphinx && \
		make configure && \
		make && \
		make install && \
		echo 'installed cysignals' 

```

### IDE
This code has been built and modified using Pycharm.
Mark the following directories as source root (1) bdd-driveratt & (2) bdd-driveratt/eye_tracking/analysis/lib/pupil/pupil_src/shared_modules for the paths to work. 
Otherwise you may need to add the paths in another way.


## Instructions of use

We want to acknowledge the work of behinger/etcomp repository (https://github.com/behinger/etcomp) of which we based the organizational structure of the code along with a few functions.

### Code to run preprocessing pipeline:

Run a subject by inputting the datapath directory & subject number (i.e. pathway where raw data from Pupil Labs glasses is saved) as seen in code below. 
```python
from eye_tracking.preprocessing.functions.et_preprocess import preprocess_et
from eye_tracking.preprocessing.functions.detect_events import make_fixations, make_blinks, make_saccades
data = preprocess_et(subject='000', datapath='/media/whitney/New Volume/Teresa/bdd-driveratt', surfaceMap=False, eventfunctions=(make_fixations, make_blinks, make_saccades))
```

preprocess_et outputs three dataframes: etsamples, etmsgs, etevents that are saved into your newly created data directory /preprocessed found within the main datapath directory.

### Event detector:

In this implementation, fixations, blinks, saccades are detected & the results are saved into your data directory /preprocessed:
- the output generated by calling the pupil api to detect fixations & blinks 
- etevents compiles all 3 event types & specifies relevant attributes
- etsamples classifies each gaze datum as an event type

### Surface detector:

We've created a new implementation of the April tags package. The main maker detector is in manual_detection.py, that runs using the april_tags package: https://github.com/pupil-labs/apriltags

To install: pip install pupil-apriltags

Make sure to update detect_tags_and_surfaces() arguments, (1) tags & (2) tags_corner_attribute, called in surface_detection.py, with your tag ids.
Current version detects 1 surface. 
If there are multiple surfaces, turn off surface detector by making surfaceMap False in preprocess_et()

Frames directory:
- Frames from world recording are saved into your data directory /frames. Note that it may take some time to create.
- Make the argument createSurfaceFrame True in detect_tags_and_surfaces(), called in surface_detection.py, to save frames annotated with surfaces into your data directory /frames/surface_frames. Note that it may take some time to create.
- If you would like to delete the entire frames directory once the surface coordinates have been extracted and saved in the preprocessed directory (to save memory), set the argument deleteFrames to true when calling map_surface() in et_import.py.


## Old Packages needed
 I believe you don't necessarily need to install these anymore, but just in case, I'm leaving them down here:

   `pkg-config`

   `automake`

   `cmake`

   `python3-dev`

   `libglew-dev`

   `xorg-dev libglu1-mesa-dev` <-- needed for libglew

   `libportaudio2` <-- for pyaudio

   `portaudio19-dev` <-- for pyaudio

   `pyaudio`